generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model Invite {
  id                 String    @id @default(cuid())
  token              String    @unique
  status             String    @default("active")
  preassignedRoleKey String?
  maxUses            Int       @default(1)
  uses               Int       @default(0)
  theme              String    @default("standard")
  createdAt          DateTime  @default(now())
  usedAt             DateTime?
  players            Player[]  @relation("InviteUsed")

  @@map("invites")
}

model Player {
  id                     String                     @id @default(cuid())
  accountId              String?
  name                   String
  contactType            String
  contactValue           String
  passwordHash           String?
  onboardingMode         String?                    @default("expert")
  onboardingComplete     Boolean                    @default(false)
  storyProgress          String?
  hasSeenWelcome         Boolean                    @default(false)
  hasCompletedFirstQuest Boolean                    @default(false)
  hasCreatedFirstQuest   Boolean                    @default(false)
  onboardingCompletedAt  DateTime?
  inviteId               String
  nationId               String?
  playbookId             String?
  pronouns               String?
  attendance             String?
  createdAt              DateTime                   @default(now())
  barSharesSent          BarShare[]                 @relation("BarSharesSent")
  barSharesReceived      BarShare[]                 @relation("BarSharesReceived")
  claimedBars            CustomBar[]                @relation("ClaimedBars")
  createdBars            CustomBar[]                @relation("CreatedBars")
  donations              Donation[]
  emotionalAidSessions   EmotionalFirstAidSession[]
  instanceMemberships    InstanceMembership[]
  bars                   PlayerBar[]
  nationMoveUnlocks      PlayerNationMoveUnlock[]
  quests                 PlayerQuest[]
  roles                  PlayerRole[]
  account                Account?                   @relation(fields: [accountId], references: [id])
  invite                 Invite                     @relation("InviteUsed", fields: [inviteId], references: [id])
  nation                 Nation?                    @relation(fields: [nationId], references: [id])
  playbook               Playbook?                  @relation(fields: [playbookId], references: [id])
  questMoveLogs          QuestMoveLog[]
  starterPack            StarterPack?
  twineBindingsCreated   TwineBinding[]             @relation("TwineBindingsCreated")
  twineRunsPlayed        TwineRun[]                 @relation("TwineRunsPlayed")
  twineStoriesCreated    TwineStory[]               @relation("TwineStoriesCreated")
  vibulonEvents          VibulonEvent[]
  vibulons               Vibulon[]

  @@unique([contactType, contactValue])
  @@map("players")
}

model Role {
  id           String       @id @default(cuid())
  key          String       @unique
  displayName  String
  description  String
  isForecasted Boolean      @default(false)
  createdAt    DateTime     @default(now())
  players      PlayerRole[]

  @@map("roles")
}

model Account {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  players      Player[]

  @@map("accounts")
}

model PlayerRole {
  id               String    @id @default(cuid())
  playerId         String
  roleId           String
  grantedByAdminId String?
  grantedAt        DateTime  @default(now())
  expiresAt        DateTime?
  player           Player    @relation(fields: [playerId], references: [id])
  role             Role      @relation(fields: [roleId], references: [id])

  @@unique([playerId, roleId])
  @@map("player_roles")
}

model Bar {
  id         Int         @id
  name       String
  tone       String
  text       String
  createdAt  DateTime    @default(now())
  assignedTo PlayerBar[]

  @@map("bars")
}

model CustomBar {
  id                   String         @id @default(cuid())
  creatorId            String
  title                String
  description          String
  type                 String         @default("vibe")
  reward               Int            @default(1)
  visibility           String         @default("public")
  claimedById          String?
  storyPath            String?
  allowedTrigrams      String?
  inputs               String         @default("[]")
  moveType             String?
  status               String         @default("active")
  kotterStage          Int            @default(1)
  storyContent         String?
  storyMood            String?
  isSystem             Boolean        @default(false)
  hexagramId           Int?
  periodGenerated      Int?
  firstCompleterId     String?
  createdAt            DateTime       @default(now())
  parentId             String?
  twineLogic           String?
  completionEffects    String?
  rootId               String?
  allowedNations       String?
  twineStoryId         String?
  shares               BarShare[]
  claimedBy            Player?        @relation("ClaimedBars", fields: [claimedById], references: [id])
  creator              Player         @relation("CreatedBars", fields: [creatorId], references: [id])
  parent               CustomBar?     @relation("CustomBarTree", fields: [parentId], references: [id])
  children             CustomBar[]    @relation("CustomBarTree")
  twineStory           TwineStory?    @relation(fields: [twineStoryId], references: [id])
  packQuests           PackQuest[]
  assignments          PlayerQuest[]
  moveLogsAsCreatedBar QuestMoveLog[] @relation("QuestMoveCreatedBar")
  questMoveLogs        QuestMoveLog[] @relation("QuestMoveQuest")
  threadQuests         ThreadQuest[]
  microTwine           MicroTwineModule?

  @@map("custom_bars")
}

model PlayerBar {
  id         String   @id @default(cuid())
  playerId   String
  barId      Int
  source     String
  notes      String?
  acquiredAt DateTime @default(now())
  bar        Bar      @relation(fields: [barId], references: [id])
  player     Player   @relation(fields: [playerId], references: [id])

  @@map("player_bars")
}

model BarShare {
  id         String    @id @default(cuid())
  barId      String
  fromUserId String
  toUserId   String
  note       String?
  createdAt  DateTime  @default(now())
  bar        CustomBar @relation(fields: [barId], references: [id], onDelete: Cascade)
  fromUser   Player    @relation("BarSharesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     Player    @relation("BarSharesReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId, createdAt])
  @@index([toUserId, createdAt])
  @@index([barId, createdAt])
  @@map("bar_shares")
}

model Quest {
  id         String   @id @default(cuid())
  title      String
  prompt     String
  returnType String
  parentId   String?
  rootId     String?
  createdAt  DateTime @default(now())
  parent     Quest?   @relation("QuestTree", fields: [parentId], references: [id])
  children   Quest[]  @relation("QuestTree")

  @@map("quests")
}

model PlayerQuest {
  id          String    @id @default(cuid())
  playerId    String
  questId     String
  status      String    @default("assigned")
  inputs      String?
  assignedAt  DateTime  @default(now())
  completedAt DateTime?
  player      Player    @relation(fields: [playerId], references: [id])
  quest       CustomBar @relation(fields: [questId], references: [id])

  @@unique([playerId, questId])
  @@map("player_quests")
}

model QuestThread {
  id               String           @id @default(cuid())
  title            String
  description      String?
  threadType       String           @default("standard")
  creatorType      String           @default("system")
  creatorId        String?
  creationCost     Int              @default(0)
  completionReward Int              @default(0)
  allowedPlaybooks String?
  gateNationId     String?
  gatePlaybookId   String?
  status           String           @default("active")
  createdAt        DateTime         @default(now())
  progress         ThreadProgress[]
  quests           ThreadQuest[]

  @@map("quest_threads")
}

model ThreadQuest {
  id       String      @id @default(cuid())
  threadId String
  questId  String
  position Int
  quest    CustomBar   @relation(fields: [questId], references: [id])
  thread   QuestThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, position])
  @@unique([threadId, questId])
  @@map("thread_quests")
}

model ThreadProgress {
  id              String      @id @default(cuid())
  threadId        String
  playerId        String
  currentPosition Int         @default(0)
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  isArchived      Boolean     @default(false)
  thread          QuestThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, playerId])
  @@map("thread_progress")
}

model QuestPack {
  id               String         @id @default(cuid())
  title            String
  description      String?
  creatorType      String         @default("system")
  creatorId        String?
  allowedPlaybooks String?
  status           String         @default("active")
  visibility       String         @default("private")
  createdAt        DateTime       @default(now())
  progress         PackProgress[]
  quests           PackQuest[]

  @@map("quest_packs")
}

model PackQuest {
  id      String    @id @default(cuid())
  packId  String
  questId String
  pack    QuestPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  quest   CustomBar @relation(fields: [questId], references: [id])

  @@unique([packId, questId])
  @@map("pack_quests")
}

model PackProgress {
  id          String    @id @default(cuid())
  packId      String
  playerId    String
  completed   String    @default("[]")
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  isArchived  Boolean   @default(false)
  pack        QuestPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@unique([packId, playerId])
  @@map("pack_progress")
}

model VibulonEvent {
  id            String   @id @default(cuid())
  playerId      String
  source        String
  amount        Int
  notes         String?
  archetypeMove String?
  questId       String?
  createdAt     DateTime @default(now())
  player        Player   @relation(fields: [playerId], references: [id])

  @@map("vibulon_events")
}

model Vibulon {
  id            String   @id @default(cuid())
  ownerId       String?
  originSource  String
  originId      String
  originTitle   String
  generation    Int      @default(1)
  stakedOnBarId String?
  createdAt     DateTime @default(now())
  owner         Player?  @relation(fields: [ownerId], references: [id])

  @@map("vibulons")
}

model Nation {
  id          String       @id @default(cuid())
  name        String       @unique
  description String
  imgUrl      String?
  archived    Boolean      @default(false)
  wakeUp      String?
  cleanUp     String?
  growUp      String?
  showUp      String?
  createdAt   DateTime     @default(now())
  moves       NationMove[]
  players     Player[]

  @@map("nations")
}

model Polarity {
  id          String       @id @default(cuid())
  key         String       @unique
  name        String
  description String?
  icon        String?
  createdAt   DateTime     @default(now())
  moves       NationMove[]

  @@map("polarities")
}

model NationMove {
  id                 String                   @id @default(cuid())
  key                String                   @unique
  nationId           String
  polarityId         String?
  name               String
  description        String
  isStartingUnlocked Boolean                  @default(false)
  appliesToStatus    String                   @default("[]")
  requirementsSchema String                   @default("{}")
  effectsSchema      String                   @default("{}")
  sortOrder          Int                      @default(0)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  nation             Nation                   @relation(fields: [nationId], references: [id], onDelete: Cascade)
  polarity           Polarity?                @relation(fields: [polarityId], references: [id])
  unlocks            PlayerNationMoveUnlock[]
  logs               QuestMoveLog[]

  @@index([nationId, sortOrder])
  @@map("nation_moves")
}

model PlayerNationMoveUnlock {
  id         String     @id @default(cuid())
  playerId   String
  moveId     String
  unlockedAt DateTime   @default(now())
  move       NationMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  player     Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, moveId])
  @@index([moveId, unlockedAt])
  @@map("player_nation_move_unlocks")
}

model QuestMoveLog {
  id           String     @id @default(cuid())
  questId      String
  moveId       String
  playerId     String
  createdBarId String?
  inputsJson   String?
  effectsJson  String?
  createdAt    DateTime   @default(now())
  createdBar   CustomBar? @relation("QuestMoveCreatedBar", fields: [createdBarId], references: [id])
  move         NationMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  player       Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  quest        CustomBar  @relation("QuestMoveQuest", fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId, createdAt])
  @@index([playerId, createdAt])
  @@map("quest_move_logs")
}

model Playbook {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String
  moves             String
  content           String?
  centralConflict   String?
  primaryQuestion   String?
  vibe              String?
  energy            String?
  shadowSignposts   String?
  lightSignposts    String?
  examples          String?
  wakeUp            String?
  cleanUp           String?
  growUp            String?
  showUp            String?
  createdAt         DateTime @default(now())
  emotionalFirstAid String?
  players           Player[]

  @@map("playbooks")
}

model EmotionalFirstAidTool {
  id          String                     @id @default(cuid())
  key         String                     @unique
  name        String
  description String
  icon        String?
  moveType    String                     @default("cleanUp")
  tags        String                     @default("[]")
  twineLogic  String
  isActive    Boolean                    @default(true)
  sortOrder   Int                        @default(0)
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  sessions    EmotionalFirstAidSession[]

  @@map("emotional_first_aid_tools")
}

model EmotionalFirstAidSession {
  id                 String                 @id @default(cuid())
  playerId           String
  toolId             String?
  contextQuestId     String?
  issueTag           String?
  issueText          String?
  stuckBefore        Int
  stuckAfter         Int?
  delta              Int?
  recommendedToolKey String?
  mintedAmount       Int                    @default(0)
  applyToQuesting    Boolean                @default(false)
  twineSnapshot      String?
  notes              String?
  createdAt          DateTime               @default(now())
  completedAt        DateTime?
  player             Player                 @relation(fields: [playerId], references: [id])
  tool               EmotionalFirstAidTool? @relation(fields: [toolId], references: [id])

  @@index([playerId, createdAt])
  @@map("emotional_first_aid_sessions")
}

model StarterPack {
  id               String   @id @default(cuid())
  playerId         String   @unique
  data             String
  initialVibeulons Int      @default(0)
  createdAt        DateTime @default(now())
  player           Player   @relation(fields: [playerId], references: [id])

  @@map("starter_packs")
}

model AuditLog {
  id           String   @id @default(cuid())
  actorAdminId String
  action       String
  targetType   String
  targetId     String
  payloadJson  String?
  createdAt    DateTime @default(now())

  @@map("audit_logs")
}

model GlobalState {
  id               String   @id
  storyClock       Int      @default(0)
  currentAct       Int      @default(1)
  currentPeriod    Int      @default(1)
  isPaused         Boolean  @default(false)
  unlockedTiers    String   @default("[]")
  hexagramSequence String   @default("[]")
  updatedAt        DateTime @updatedAt

  @@map("global_state")
}

model StoryTick {
  id          String   @id @default(cuid())
  tickNumber  Int
  actNumber   Int
  trigger     String
  description String
  createdAt   DateTime @default(now())

  @@map("story_ticks")
}

model TwineStory {
  id          String         @id @default(cuid())
  title       String
  slug        String?        @unique
  sourceType  String         @default("twine_html")
  sourceText  String
  parsedJson  String         @default("{}")
  isPublished Boolean        @default(false)
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  quests      CustomBar[]
  bindings    TwineBinding[]
  runs        TwineRun[]
  createdBy   Player         @relation("TwineStoriesCreated", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById, createdAt])
  @@map("twine_stories")
}

model TwineRun {
  id               String     @id @default(cuid())
  storyId          String
  playerId         String
  questId          String?
  currentPassageId String
  visited          String     @default("[]")
  firedBindings    String     @default("[]")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  completedAt      DateTime?
  player           Player     @relation("TwineRunsPlayed", fields: [playerId], references: [id], onDelete: Cascade)
  story            TwineStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, playerId, questId])
  @@index([playerId, updatedAt])
  @@map("twine_runs")
}

model TwineBinding {
  id          String     @id @default(cuid())
  storyId     String
  scopeType   String
  scopeId     String
  actionType  String
  payload     String
  createdById String
  createdAt   DateTime   @default(now())
  createdBy   Player     @relation("TwineBindingsCreated", fields: [createdById], references: [id], onDelete: Cascade)
  story       TwineStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, scopeType, scopeId])
  @@map("twine_bindings")
}

model Instance {
  id                 String               @id @default(cuid())
  slug               String               @unique
  name               String
  domainType         String
  theme              String?
  targetDescription  String?
  goalAmountCents    Int?
  currentAmountCents Int                  @default(0)
  isEventMode        Boolean              @default(false)
  stripeOneTimeUrl   String?
  patreonUrl         String?
  startDate          DateTime?
  endDate            DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  activeInConfigs    AppConfig[]
  donations          Donation[]
  memberships        InstanceMembership[]

  @@map("instances")
}

model Donation {
  id          String   @id @default(cuid())
  instanceId  String
  playerId    String?
  amountCents Int
  provider    String   @default("manual")
  externalId  String?
  note        String?
  createdAt   DateTime @default(now())
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  player      Player?  @relation(fields: [playerId], references: [id])

  @@index([instanceId, createdAt])
  @@index([playerId, createdAt])
  @@map("donations")
}

model InstanceMembership {
  id         String   @id @default(cuid())
  instanceId String
  playerId   String
  roleKey    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([instanceId, playerId])
  @@index([instanceId, createdAt])
  @@map("instance_memberships")
}

model AppConfig {
  id                 String    @id @default("singleton")
  features           String    @default("{}")
  theme              String    @default("{}")
  heroTitle          String?
  heroSubtitle       String?
  updatedAt          DateTime  @updatedAt
  updatedBy          String?
  activeInstanceId   String?
  orientationQuestId String?
  activeInstance     Instance? @relation(fields: [activeInstanceId], references: [id])

  @@map("app_config")
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  target    String?
  payload   String
  createdAt DateTime @default(now())

  @@map("admin_audit_log")
}

model MicroTwineModule {
  id               String       @id @default(cuid())
  questId          String       @unique
  canonicalJson    String       // Form structure (Moments, Options)
  tweeSource       String       // Generated SugarCube Twee
  htmlArtifact     String?      // Compiled Twine HTML (Base64 or String)
  isDraft          Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  quest            CustomBar    @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@map("micro_twine_modules")
}
