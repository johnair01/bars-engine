// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// ENUMS & TYPES
// --------------------------------------------------------

// Simple enums for status/types
// (SQLite doesn't support native enums well, but Prisma handles them)

// --------------------------------------------------------
// CORE: PLAYERS & IDENTITY
// --------------------------------------------------------

model Invite {
  id                String    @id @default(cuid())
  token             String    @unique
  status            String    @default("active") // active, used, revoked
  preassignedRoleKey String?  // Optional role to auto-grant
  
  maxUses           Int       @default(1)
  uses              Int       @default(0)
  
  players           Player[]  @relation("InviteUsed")
  
  // Theme for specific landing page experiences (e.g. 'standard', 'oceans11')
  theme             String    @default("standard")
  
  createdAt         DateTime  @default(now())
  usedAt            DateTime?
  
  @@map("invites")
}

model Player {
  id              String    @id @default(cuid())
  
  // Auth / Contact
  name            String
  contactType     String    // email, phone
  contactValue    String
  
  // Relations
  inviteId        String    // removed @unique to allow reusable invites
  invite          Invite    @relation("InviteUsed", fields: [inviteId], references: [id])
  
  roles           PlayerRole[]
  
  // Character Creation 2.0
  nationId        String?
  nation          Nation?   @relation(fields: [nationId], references: [id])
  
  playbookId      String?
  playbook        Playbook? @relation(fields: [playbookId], references: [id])
  
  pronouns        String?
  attendance      String?   // "in_person", "online"
  starterPack     StarterPack?

  bars            PlayerBar[]
  quests          PlayerQuest[]
  vibulonEvents   VibulonEvent[]
  vibulons        Vibulon[]
  
  // CustomBar relations
  createdBars     CustomBar[]   @relation("CreatedBars")
  claimedBars     CustomBar[]   @relation("ClaimedBars")
  
  createdAt       DateTime  @default(now())

  @@unique([contactType, contactValue]) // ensure unique email/phone
  @@map("players")
}

// --------------------------------------------------------
// ROLES & PROGRESSION
// --------------------------------------------------------

model Role {
  id              String    @id @default(cuid())
  key             String    @unique // ACE, VETERAN, ENGINEER, ROOKIE, LEADER
  displayName     String
  description     String
  isForecasted    Boolean   @default(false)
  
  players         PlayerRole[]
  
  createdAt       DateTime  @default(now())
  
  @@map("roles")
}

model PlayerRole {
  id              String    @id @default(cuid())
  
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id])
  
  roleId          String
  role            Role      @relation(fields: [roleId], references: [id])
  
  grantedByAdminId String?  // For audit
  
  grantedAt       DateTime  @default(now())
  expiresAt       DateTime?
  
  @@unique([playerId, roleId])
  @@map("player_roles")
}

// --------------------------------------------------------
// STORY & STATE (BARS)
// --------------------------------------------------------

model Bar {
  id              Int       @id // 1..64 (manual ID)
  name            String    // "The Creative", "The Receptive", etc.
  tone            String    // description or vibe
  text            String    // poetic text
  
  assignedTo      PlayerBar[]
  
  createdAt       DateTime  @default(now())
  
  @@map("bars")
}

// User-created Bars (quests/tasks anyone can create)
model CustomBar {
  id              String    @id @default(cuid())
  
  creatorId       String
  creator         Player    @relation("CreatedBars", fields: [creatorId], references: [id])
  
  title           String
  description     String
  type            String    @default("vibe") // vibe, story
  reward          Int       @default(1)
  
  // Visibility: public (anyone can see/pick up), private (creator only, must delegate)
  visibility      String    @default("public")
  
  // Who has claimed/picked up this bar (NULL = unclaimed, available)
  claimedById     String?
  claimedBy       Player?   @relation("ClaimedBars", fields: [claimedById], references: [id])
  
  // For story bars
  storyPath       String? // "collective", "personal"
  allowedTrigrams String? // JSON array of allowed Playbooks ["Heaven", "Earth"]
  
  // Input definition (JSON array of BarInput)
  inputs          String    @default("[]")
  
  // Move Type: wakeUp, cleanUp, growUp, showUp (optional categorization)
  moveType        String?   // wakeUp, cleanUp, growUp, showUp
  
  status          String    @default("active") // active, archived
  
  createdAt       DateTime  @default(now())
  
  @@map("custom_bars")
}

model PlayerBar {
  id              String    @id @default(cuid())
  
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id])
  
  barId           Int
  bar             Bar       @relation(fields: [barId], references: [id])
  
  source          String    // engine, admin, trade, ritual
  notes           String?
  
  acquiredAt      DateTime  @default(now())
  
  @@map("player_bars")
}

// --------------------------------------------------------
// QUESTS & TASKS
// --------------------------------------------------------

model Quest {
  id              String    @id @default(cuid())
  title           String
  prompt          String
  returnType      String    // "text", "image", "gps"
  
  assignments     PlayerQuest[]
  
  createdAt       DateTime  @default(now())
  
  @@map("quests")
}

model PlayerQuest {
  id              String    @id @default(cuid())
  
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id])
  
  questId         String
  quest           Quest     @relation(fields: [questId], references: [id])
  
  status          String    @default("assigned") // assigned, completed, failed
  returnText      String?
  
  assignedAt      DateTime  @default(now())
  completedAt     DateTime?
  
  @@map("player_quests")
}

// --------------------------------------------------------
// ECONOMY (VIBULONS & EVENTS)
// --------------------------------------------------------

model VibulonEvent {
  id              String    @id @default(cuid())
  
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id])
  
  source          String    // quest, role, admin, ritual
  amount          Int       // usually +1
  notes           String?
  
  createdAt       DateTime  @default(now())
  
  @@map("vibulon_events")
}

model Vibulon {
  id          String   @id @default(cuid())
  
  ownerId     String?
  owner       Player?   @relation(fields: [ownerId], references: [id])
  
  // Provenance (The "Story" carried by the coin)
  originSource String   // "starter", "custom", "iching", "system"
  originId     String   // ID of the bar/quest
  originTitle  String   // Snapshot of title

  // Staking/Escrow (When attached to a Bar)
  stakedOnBarId String? // ID of the PlayerBar or CustomBar instance
  
  createdAt   DateTime @default(now())
  
  @@map("vibulons")
}

// --------------------------------------------------------
// CHARACTER CREATION 2.0 (STORY ENGINE)
// --------------------------------------------------------

model Nation {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  imgUrl      String?
  
  // Basic Moves (Nation's interpretation)
  wakeUp      String?  // Awareness move
  cleanUp     String?  // Shadow work move
  growUp      String?  // Development move
  showUp      String?  // Action move
  
  players     Player[]
  
  createdAt   DateTime @default(now())
  
  @@map("nations")
}

model Playbook {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  moves       String   // JSON string of special moves
  
  // Basic Moves (Playbook's interpretation)
  wakeUp      String?  // Awareness move
  cleanUp     String?  // Shadow work move
  growUp      String?  // Development move
  showUp      String?  // Action move
  
  players     Player[]
  
  createdAt   DateTime @default(now())
  
  @@map("playbooks")
}

model StarterPack {
  id              String    @id @default(cuid())
  
  playerId        String    @unique
  player          Player    @relation(fields: [playerId], references: [id])
  
  data            String    // JSON: { completedBars: [{ id, inputs }] }
  initialVibeulons Int      @default(0)
  
  createdAt       DateTime  @default(now())
  
  @@map("starter_packs")
}

model AuditLog {
  id              String    @id @default(cuid())
  
  actorAdminId    String
  action          String    // "GRANT_ROLE", "RESET_BAR", etc.
  targetType      String    // "player", "system"
  targetId        String
  payloadJson     String?   // Details
  
  createdAt       DateTime  @default(now())
  
  @@map("audit_logs")
}

model GlobalState {
  id              String    @id // Singleton: "singleton"
  
  storyClock      Int       @default(0)
  currentAct      Int       @default(1)
  
  // JSON array of unlocked tier IDs or flags
  unlockedTiers   String    @default("[]") 
  
  // Shuffled sequence of 1-64
  hexagramSequence String   @default("[]") 
  
  updatedAt       DateTime  @updatedAt
  
  @@map("global_state")
}

model StoryTick {
  id              String    @id @default(cuid())
  
  tickNumber      Int       // The clock value at this tick
  actNumber       Int       // The act value at this tick
  
  trigger         String    // "manual", "auto_threshold", "event_trigger"
  description     String
  
  createdAt       DateTime  @default(now())
  
  @@map("story_ticks")
}
